# Zion Database Analysis - December 9, 2025

## Room Configuration Analysis

### Courses with Multiple Rooms

88 courses have more than 1 room configured. The top courses have up to 27 rooms each, with many rooms shared across courses.

| Course | Semester | Room Count |
|--------|----------|------------|
| CMSC132 (676C9) | Spring 2025 | 27 |
| CMSC131 Object-Oriented Programming I | Spring 2025 | 27 |
| CMSC398Z Effective use of AI coding assistants | Fall 2025 | 27 |
| CMSC330 (D97A2) | Spring 2025 | 27 |
| MSML650 Cloud Computing | Fall 2025 | 27 |

### Room Inventory

- **148 total rooms** in the system
- **27 virtual rooms** (room_type = 'virtual')
- **121 physical rooms** (room_type = 'physical')
- **46 rooms** have 0 courses assigned (orphaned)

Top rooms by course association:

| Room Name | Type | Courses |
|-----------|------|---------|
| Virtual (Virtual) | virtual | 68 |
| Zoom (Virtual) | virtual | 64 |
| Hope OH (Virtual) | virtual | 52 |
| Tin OH (Virtual) | virtual | 51 |
| Marine OH (Virtual) | virtual | 49 |

### Duplicate Room Names

Multiple rooms exist with the same name. For example, "Hope OH (Virtual)" exists twice:

| Room ID | Created | Courses Assigned |
|---------|---------|------------------|
| ac4aa8cc... | Sep 8, 2023 | 52 |
| 8d6a9553... | Sep 18, 2023 | 48 |

## Root Cause: Room Creation Logic

### No Deduplication on Room Creation

When an instructor creates a room, the system **always creates a new room** regardless of whether a room with the same name already exists.

**File:** `data/room/room_service.go:65-78`

```go
func (r *RoomService) CreateRoom(input CreateRoomInput) (*Room, error) {
    roomSQL := `INSERT INTO rooms (institution_id, name, typ, location, url)
                VALUES ($1, $2, $3, $4, $5) RETURNING id, name, typ, location, url`
    // Direct insert, no existence check
    ...
}
```

The database schema has **no unique constraint** on room names, allowing duplicates.

### Auto-Assignment of Virtual Rooms to New Courses

When a new course is created, **ALL virtual rooms** in the institution are automatically assigned to it.

**File:** `data/course/course_service.go:104-143`

```go
roomSQL := `INSERT INTO course_rooms (room_id, course_id)
            SELECT id, $1 FROM rooms WHERE typ = 'virtual' AND institution_id = $2`
```

This means:
1. If "Hope OH (Virtual)" is created twice, both rooms exist separately
2. Every new course gets **both** duplicate rooms auto-assigned
3. The room count per course keeps growing as more virtual rooms are created

## Conversation and Interaction Analysis

### Room Usage

All conversations happen in **physical rooms only**:

| Room Type | Conversations | Interactions |
|-----------|---------------|--------------|
| Physical | 37,335 | 124,824 |
| Virtual | 0 | 0 |

Virtual rooms are configured but never used for actual office hours.

### Interaction Types

| Interaction Type | Count | Description |
|------------------|-------|-------------|
| enqueue | 37,335 | Student joins the queue |
| resolve | 36,099 | Issue resolved after being helped |
| dequeue | 33,408 | TA takes student from queue |
| leave | 8,044 | Student left the queue before being helped |
| requeue | 4,155 | Student re-enters the queue |
| open | 4,011 | No resolution reached, conversation left open |
| no_show | 1,772 | Student didn't show up after being dequeued |

### Conversation Flow Patterns

| Interactions per Conversation | Count | % of Total |
|-------------------------------|-------|------------|
| 1 | 36 | 0.1% |
| 2 | 702 | 1.9% |
| 3 | 30,140 | 80.7% |
| 4 | 3,215 | 8.6% |
| 5 | 1,309 | 3.5% |
| 6+ | 1,933 | 5.2% |

- **81% of conversations** have exactly 3 interactions (typical flow: enqueue → dequeue → resolve)
- **702 conversations** have 2 interactions (likely: enqueue → leave)
- **36 conversations** have only 1 interaction (incomplete/orphaned)
- Some edge cases have up to 23 interactions (multiple requeues)

## Misclassified Room Types

### Physical Rooms Used for Virtual Meetings

**29 rooms** are marked as `physical` type but have "zoom", "virtual", or "online" in their name or location:

| Room Name | Location | Courses |
|-----------|----------|---------|
| ZOOM (9 duplicates) | ZOOM | 1 each |
| Virtual | ZOOM | 1 |
| Virtual OH | VIRTUAL | 1 |
| ONLINE OH | ONLINE | 1 |
| For Virtual OH | ZOOM | 1 |
| The TAs' Zoom office hours "room"... | TAZOOM | 1 |
| + others with 0 courses | | |

This is a data quality issue - these rooms should be typed as `virtual`, not `physical`.

### Courses with Multiple Physical Rooms

Initially, **18 courses** appeared to have multiple physical rooms. However, after filtering out misclassified virtual rooms (those with zoom/virtual/online in name or location), only **8 courses** truly have 2+ physical locations:

| Course | Semester | Room Name | Location |
|--------|----------|-----------|----------|
| **CMSC411** | Spring 2025 | Instructor Office Hours | IRB5148 |
| | | TA Office Hours | IRB2207 |
| **CMSC106** | Spring 2024 | Instructor Office | IRB 2246 |
| | | IRB 1107 Open Area | IRB 1107 |
| **CMSC132** | Spring 2024 | Instructor Office | IRB 2246 |
| | | IRB 1108 (TA OH) | IRB 1108 |
| **CMSC320** | Spring 2024 | AVW4122 | AVW4122 |
| | | Hillary's OH | IRB2119 |
| **CMSC411** | Spring 2024 | 411 TA OH | IRB-5119 |
| | | Bahar OH | IRB-5148 |
| **HOMO101** | Spring 2024 | Ishaan's Office | 1525 |
| | | Ishaans Room | IRB2022 |
| **CMSC131** | Fall 2024 | Elias' Office - IRB 1252 | IRB 1252 |
| | | TA Hours - IRB 1108 | IRB 1108 |
| **CMSC216** | Fall 2023 | AVW 4166 | AVW 4166 |
| | | IRB2246 | IRB2246 |

All 8 courses follow the pattern of having separate instructor and TA office hours locations.

## Recommendations

1. **Add unique constraint** on room names per institution to prevent duplicates
2. **Add room lookup** before creation to reuse existing rooms with same name
3. **Review virtual room auto-assignment** - since virtual rooms are never used, this logic may be unnecessary
4. **Clean up orphaned rooms** - 46 rooms have no course associations
5. **Deduplicate existing rooms** - merge duplicate rooms and update course_rooms references
6. **Fix misclassified room types** - update the 29 physical rooms with zoom/virtual/online in their name/location to be typed as `virtual`
7. **Add room type validation** - consider auto-detecting room type based on name/location patterns, or warn users when creating a "physical" room with a virtual-sounding name
